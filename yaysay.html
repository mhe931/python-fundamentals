<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YaysayBot Core Workflow Flowchart (Canvas)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f4f6f9; color: #333; }
        h1 { color: #007aff; border-bottom: 2px solid #007aff; padding-bottom: 10px; }
        h2 { color: #5a5a5a; margin-top: 30px; border-left: 5px solid #ccc; padding-left: 10px; }
        #flowCanvas {
            border: 1px solid #ccc;
            background-color: #fff;
            display: block;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <h1>YaysayBot Core Flows Visualization</h1>
    <p>This visualization uses the HTML5 Canvas element to show the two main bot workflows: User Registration and Poll Creation.</p>
    <canvas id="flowCanvas" width="1150" height="950">
        Your browser does not support the HTML5 canvas tag.
    </canvas>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('flowCanvas');
            const ctx = canvas.getContext('2d');
            
            // --- Configuration ---
            const boxWidth = 200;
            const boxHeight = 60;
            const x_reg = 100; // Registration Flow X-start
            const x_poll = 450; // Poll Flow X-start
            const x_points = 800; // Points Flow X-start
            const yStart = 50;
            const yStep = 100;
            const arrowLength = 50;

            // --- Styling Functions ---

            function drawArrow(x1, y1, x2, y2, label = '', align = 'center') {
                ctx.beginPath();
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();

                // Draw arrow head (simple triangle)
                const headlen = 10;
                const angle = Math.atan2(y2 - y1, x2 - x1);
                ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
                ctx.moveTo(x2, y2);
                ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
                ctx.stroke();

                // Draw label
                if (label) {
                    ctx.fillStyle = '#1e88e5';
                    ctx.font = '12px Arial';
                    let textX = (x1 + x2) / 2;
                    let textY = (y1 + y2) / 2;
                    
                    if (align === 'center') {
                        ctx.textAlign = 'center';
                        textY += 15;
                    } else if (align === 'right') {
                        ctx.textAlign = 'left';
                        textX += 5; 
                    } else if (align === 'left') {
                        ctx.textAlign = 'right';
                        textX -= 5;
                    }
                    ctx.fillText(label, textX, textY);
                }
            }

            function drawBox(x, y, w, h, text, color = '#2196f3') {
                const textLines = text.split('\n');
                
                ctx.fillStyle = color;
                ctx.fillRect(x, y, w, h);
                ctx.strokeStyle = '#333';
                ctx.strokeRect(x, y, w, h);

                ctx.fillStyle = '#fff';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';

                // Center multi-line text
                const lineHeight = 18;
                let startY = y + (h / 2) - ((textLines.length - 1) * lineHeight / 2);
                textLines.forEach((line, index) => {
                    ctx.fillText(line, x + w / 2, startY + (index * lineHeight));
                });
            }

            function drawDiamond(x, y, w, h, text, color = '#ff9800') {
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.moveTo(x + w / 2, y);
                ctx.lineTo(x + w, y + h / 2);
                ctx.lineTo(x + w / 2, y + h);
                ctx.lineTo(x, y + h / 2);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = '#333';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(text, x + w / 2, y + h / 2 + 5);
            }

            function drawStartEnd(x, y, w, h, text, color = '#4caf50') {
                const radius = h / 2;
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(x + radius, y + radius, radius, Math.PI / 2, 3 * Math.PI / 2, false); // Left semicircle
                ctx.lineTo(x + w - radius, y); // Top line
                ctx.arc(x + w - radius, y + radius, radius, 3 * Math.PI / 2, Math.PI / 2, false); // Right semicircle
                ctx.lineTo(x + radius, y + h); // Bottom line
                ctx.closePath();
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = '#fff';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(text, x + w / 2, y + h / 2 + 5);
            }

            // --- Title Text ---
            ctx.fillStyle = '#1e88e5';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('User Registration Flow', x_reg + boxWidth / 2, 30);
            ctx.fillText('Poll Creation Flow', x_poll + boxWidth / 2, 30);
            ctx.fillText('Point Request Flow', x_points + boxWidth / 2, 30);


            // ------------------------------------------------------------------
            // | 1. USER REGISTRATION FLOW                                      |
            // ------------------------------------------------------------------
            let y = yStart;

            // Start
            drawStartEnd(x_reg, y, boxWidth, boxHeight, 'START /start', '#4caf50');
            drawArrow(x_reg + boxWidth / 2, y + boxHeight, x_reg + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // Step 1: Language
            drawBox(x_reg, y, boxWidth, boxHeight, 'Select Language\n(Inline Keyboard)', '#009688');
            drawArrow(x_reg + boxWidth / 2, y + boxHeight, x_reg + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // Step 2: Sex/Age
            drawBox(x_reg, y, boxWidth, boxHeight, 'Sex & Age Selection\n(Inline Keyboards)', '#009688');
            drawArrow(x_reg + boxWidth / 2, y + boxHeight, x_reg + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // Step 3: City
            drawBox(x_reg, y, boxWidth, boxHeight, 'City Input\n(Fuzzy Matching: RapidFuzz)', '#009688');
            drawArrow(x_reg + boxWidth / 2, y + boxHeight, x_reg + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // Step 4: DB Update
            drawBox(x_reg, y, boxWidth, boxHeight, 'DB Update: Role="User"\nPoints = 50', '#795548');
            drawArrow(x_reg + boxWidth / 2, y + boxHeight, x_reg + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // Step 5: Manager Notify
            drawBox(x_reg, y, boxWidth, boxHeight, 'Notify Manager\n(New Profile + Picture)', '#f44336');
            drawArrow(x_reg + boxWidth / 2, y + boxHeight, x_reg + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // End
            drawStartEnd(x_reg, y, boxWidth, boxHeight, 'END\nShow Main User Keyboard', '#4caf50');


            // ------------------------------------------------------------------
            // | 2. POLL CREATION FLOW                                          |
            // ------------------------------------------------------------------
            y = yStart;

            // Start (from User Keyb)
            drawStartEnd(x_poll, y, boxWidth, boxHeight, 'START\n"New Poll" Button', '#2196f3');
            drawArrow(x_poll + boxWidth / 2, y + boxHeight, x_poll + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // Decision: Check Points
            drawDiamond(x_poll, y, boxWidth, boxHeight, 'Points >= 10?', '#ff9800');
            drawArrow(x_poll + boxWidth / 2, y + boxHeight, x_poll + boxWidth / 2, y + boxHeight + arrowLength, 'Yes');
            drawArrow(x_poll + boxWidth, y + boxHeight / 2, x_poll + boxWidth + 50, y + boxHeight / 2, 'No', 'right');
            
            // "No" Path
            drawBox(x_poll + boxWidth + 50, y + boxHeight / 2 - boxHeight/2, boxWidth-50, boxHeight, 'Notify: Need Points', '#ff5722');
            drawArrow(x_poll + boxWidth + 50 + (boxWidth-50)/2, y + boxHeight/2 + boxHeight/2, x_poll + boxWidth / 2, y + boxHeight * 4.5, 'Goes back to main flow', 'right'); // Rough loop back to end of the chain for simplicity
            
            y += yStep;

            // Step 1: Get Content
            drawBox(x_poll, y, boxWidth, boxHeight, 'User Sends Content\n(Text/Photos)', '#795548');
            drawArrow(x_poll + boxWidth / 2, y + boxHeight, x_poll + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // Decision: Multi Photo
            drawDiamond(x_poll, y, boxWidth, boxHeight, 'Multiple Photos?', '#ff9800');
            drawArrow(x_poll + boxWidth / 2, y + boxHeight, x_poll + boxWidth / 2, y + boxHeight + arrowLength, 'Yes');
            drawArrow(x_poll + boxWidth, y + boxHeight / 2, x_poll + boxWidth + 100, y + boxHeight / 2 + yStep/2, 'No', 'right'); // No goes around merge

            y += yStep;

            // Step 2: Merge Photo (Yes Path)
            drawBox(x_poll, y, boxWidth, boxHeight, 'Image Processing\n(Merge/Confirm)', '#795548');
            drawArrow(x_poll + boxWidth / 2, y + boxHeight, x_poll + boxWidth / 2, y + boxHeight + arrowLength);

            // "No" Path Merge
            ctx.beginPath();
            ctx.moveTo(x_poll + boxWidth + 100, yStart + yStep * 2.5);
            ctx.lineTo(x_poll + boxWidth + 100, y + boxHeight / 2);
            ctx.lineTo(x_poll + boxWidth / 2, y + boxHeight / 2);
            ctx.stroke();

            y += yStep;

            // Step 3: Deduct Points
            drawBox(x_poll, y, boxWidth, boxHeight, 'Points Deducted (-10)\nDB: Status="pending"', '#f44336');
            drawArrow(x_poll + boxWidth / 2, y + boxHeight, x_poll + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // Step 4: Manager Approval
            drawBox(x_poll, y, boxWidth, boxHeight, 'Send to Manager Channel\n(Inline Approve/Reject)', '#f44336');
            
            // --- Continuation of Poll Flow (Approval) ---
            drawArrow(x_poll + boxWidth / 2, y + boxHeight, x_poll + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;
            
            // Decision: Approved?
            drawDiamond(x_poll, y, boxWidth, boxHeight, 'Manager Approved?', '#ff9800');
            drawArrow(x_poll + boxWidth / 2, y + boxHeight, x_poll + boxWidth / 2, y + boxHeight + arrowLength, 'Yes');
            
            // Reject Path
            drawArrow(x_poll + boxWidth, y + boxHeight / 2, x_poll + boxWidth + 50, y + boxHeight / 2, 'No (Reject)', 'right');
            drawBox(x_poll + boxWidth + 50, y + boxHeight / 2 - boxHeight/2, boxWidth-50, boxHeight, 'Notify User\nPoints Refunded (+10)', '#ff5722');
            drawArrow(x_poll + boxWidth + 50 + (boxWidth-50)/2, y + boxHeight/2 + boxHeight/2, x_poll + boxWidth / 2, y + yStep + boxHeight*2.5, 'Goes back to end', 'right'); // Rough loop back to end of the chain for simplicity

            y += yStep;

            // Step 5: Broadcast
            drawBox(x_poll, y, boxWidth, boxHeight, 'Smart Broadcasting\n(Rate-Limited to All Users)', '#2196f3');
            drawArrow(x_poll + boxWidth / 2, y + boxHeight, x_poll + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // End
            drawStartEnd(x_poll, y, boxWidth, boxHeight, 'END\nPoll is Live', '#4caf50');


            // ------------------------------------------------------------------
            // | 3. POINT REQUEST FLOW                                          |
            // ------------------------------------------------------------------
            y = yStart;
            const x_pr = x_points;

            // Start (from User Keyb)
            drawStartEnd(x_pr, y, boxWidth, boxHeight, 'START\n"Request Points" Button', '#2196f3');
            drawArrow(x_pr + boxWidth / 2, y + boxHeight, x_pr + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // Step 1: Get Reason
            drawBox(x_pr, y, boxWidth, boxHeight, 'Get Reason from User\n(ConversationHandler)', '#795548');
            drawArrow(x_pr + boxWidth / 2, y + boxHeight, x_pr + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // Step 2: Request DB
            drawBox(x_pr, y, boxWidth, boxHeight, 'Save Request to DB\nStatus="pending"', '#f44336');
            drawArrow(x_pr + boxWidth / 2, y + boxHeight, x_pr + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // Step 3: Admin Notify
            drawBox(x_pr, y, boxWidth, boxHeight, 'Notify Admin\n(Inline Approve/Reject)', '#f44336');
            drawArrow(x_pr + boxWidth / 2, y + boxHeight, x_pr + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // Decision: Approved?
            drawDiamond(x_pr, y, boxWidth, boxHeight, 'Admin Approved?', '#ff9800');
            drawArrow(x_pr + boxWidth / 2, y + boxHeight, x_pr + boxWidth / 2, y + boxHeight + arrowLength, 'Yes');
            
            // Reject Path
            drawArrow(x_pr + boxWidth, y + boxHeight / 2, x_pr + boxWidth + 50, y + boxHeight / 2, 'No (Reject)', 'right');
            drawBox(x_pr + boxWidth + 50, y + boxHeight / 2 - boxHeight/2, boxWidth-50, boxHeight, 'Notify User\nRequest Closed', '#ff5722');
            drawArrow(x_pr + boxWidth + 50 + (boxWidth-50)/2, y + boxHeight/2 + boxHeight/2, x_pr + boxWidth / 2, y + yStep + boxHeight*2.5, 'Goes back to end', 'right'); // Rough loop back to end of the chain for simplicity


            y += yStep;
            
            // Step 4: Add Points
            drawBox(x_pr, y, boxWidth, boxHeight, 'Add Points to User\n(+10, +50, or +100)', '#4caf50');
            drawArrow(x_pr + boxWidth / 2, y + boxHeight, x_pr + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // Step 5: Notify
            drawBox(x_pr, y, boxWidth, boxHeight, 'Notify User & Admin\n(Audit Trail Logged)', '#4caf50');
            drawArrow(x_pr + boxWidth / 2, y + boxHeight, x_pr + boxWidth / 2, y + boxHeight + arrowLength);
            y += yStep;

            // End
            drawStartEnd(x_pr, y, boxWidth, boxHeight, 'END\nRequest Closed', '#4caf50');
        });
    </script>

</body>
</html>
